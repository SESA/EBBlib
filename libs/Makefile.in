WARNINGS := -Wall -Wshadow -Wpointer-arith -Wstrict-prototypes
CFLAGS += -g -O2 $(WARNINGS) -I$(INSTALLDIR)/include \
		-I$(L4HALDIR)/include \
		$(addprefix -D,$(DEFINES))

ARCHIVES := libebb.a


SRCFILES :=
HDRFILES :=

LIBS := counter ebblib base

VPATH := $(addprefix $(SRCDIR)/, $(LIBS))

MAKEFILES := $(addprefix $(SRCDIR)/, $(LIBS))
MAKEFILES := $(addsuffix /Makefile.in, $(MAKEFILES))

include $(MAKEFILES)

OBJFILES := $(patsubst %.c, %.o, $(SRCFILES))
DEPFILES := $(patsubst %.c, %.d, $(SRCFILES))

.PHONY: all install_headers install_archives clean

all: install_headers $(ARCHIVES) install_archives

install_headers: $(HDRFILES)
	mkdir -p $(INSTALLDIR)/include
	cp $^ $(INSTALLDIR)/include

install_archives: $(ARCHIVES)
	mkdir -p $(INSTALLDIR)/lib
	cp $< $(INSTALLDIR)/lib

clean:
	rm $(wildcard $(OBJFILES) $(DEPFILES) $(ARCHIVES))
	rm -rf $(INSTALLDIR)

libebb.a: $(OBJFILES)
	$(AR) r $@ $?


-include $(DEPFILES)

.SECONDEXPANSION:
%.o: %.c Makefile $(SRCDIR)/Makefile.in $$(@D)/Makefile.in
	$(CC) $(CFLAGS) -MMD -MP -c $< -o $@