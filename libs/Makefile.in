WARNINGS := -Wall -Wshadow -Wpointer-arith -Wstrict-prototypes
CFLAGS += -g -O2 $(WARNINGS) -I$(INCLUDEDIR) \
		-I$(L4HALDIR)/include \
		$(addprefix -D,$(DEFINES))

ARCHIVES := libebb.a


SRCFILES :=
HDRFILES :=

LIBS := counter ebblib base

VPATH := $(addprefix $(SRCDIR)/, $(LIBS))

MAKEFILES := $(addprefix $(SRCDIR)/, $(LIBS))
MAKEFILES := $(addsuffix /Makefile.in, $(MAKEFILES))

include $(MAKEFILES)

OBJFILES := $(patsubst %.c, %.o, $(SRCFILES))
DEPFILES := $(patsubst %.c, %.d, $(SRCFILES))
INSTALLED_HDRS := $(addprefix $(INCLUDEDIR)/,$(HDRFILES))
INSTALLED_ARCHIVES := $(addprefix $(LIBDIR)/,$(ARCHIVES))

.PHONY: all clean

all: $(INSTALLED_HDRS) $(INSTALLED_ARCHIVES)

clean:
	rm $(wildcard $(OBJFILES) $(DEPFILES) $(ARCHIVES))
	rm -rf $(INSTALLDIR)

libebb.a: $(OBJFILES)
	$(AR) r $@ $?

$(INCLUDEDIR) $(LIBDIR):
	mkdir -p $@

-include $(DEPFILES)

.SECONDEXPANSION:
$(INSTALLED_HDRS) $(INSTALLED_ARCHIVES): $$(@F) | $(INCLUDEDIR) $(LIBDIR)
	cp $< $@

%.o: %.c Makefile $(SRCDIR)/Makefile.in $$(@D)/Makefile.in
	$(CC) $(CFLAGS) -MMD -MP -c $< -o $@