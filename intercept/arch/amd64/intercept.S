/*
 * Copyright (C) 2012 by Project SESA, Boston University
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

        .text
        .align 8
        .globl interceptProxyFuncCommon
        .type  interceptProxyFuncCommon,@function
interceptProxyFuncCommon:
        //save floating reg
        sub     $520, %rsp
        fwait
        fxsave  (%rsp)

        //save integer registers
        pushq   %rax
        pushq   %r10
        pushq	%r9
        pushq	%r8
        pushq	%rcx
        pushq	%rdx
        pushq	%rsi
        pushq	%rdi

        movq    %rsp, %rdi //pass the argument struct as first param
        movq    %r11, %rsi //pass the funcnum as second param
        subq    $16, %rsp
        movq    %rsp, %rdx //pass the other return
        call    intercept_precall
        //if the return value is not 0, we return the value stored
        // on the stack (passed as 3rd param) and do not make the call
        testq   %rax, %rax
        jne     .Lfail

        //otherwise we are going to make the call to the function
        // stored on the stack (passed as 3rd param)

        //store the previous return address on the alt stack
        movq    (520 + 8*8 + 16)(%rsp), %rdi
        call    lrt_event_altstack_push

        //pop off the function address
        popq    %r11
        addq     $8, %rsp

        //restore int registers
        popq    %rdi
        popq    %rsi
        popq    %rdx
        popq    %rcx
        popq    %r8
        popq    %r9
        popq    %r10
        popq    %rax

        //restore floating point registers
        fxrstor (%rsp)
        //we add an extra 8 bytes to overwrite the return address
        add     $528, %rsp

        callq   *%r11

        //temp save the return value
        pushq   %rax
        //pop the return addr off the alt stack
        call    lrt_event_altstack_pop
        //pop the return value into rdi (1st param)
        popq    %rdi
        //push the return addr onto the stack and jmp
        pushq   %rax
        jmp     intercept_postcall

.Lfail:
        popq    %rax //pop the 3rd arg address as return value
        addq    $(520 + 8*8 + 8), %rsp
        ret


#define INTERCEPT_DEFAULT_FUNC(OP)            \
        .text                                ;\
        .align 8                             ;\
        .globl interceptor_proxy_func_ ## OP ;\
interceptor_proxy_func_ ## OP:               ;\
        movq    $OP, %r11                    ;\
        jmp     interceptProxyFuncCommon

INTERCEPT_DEFAULT_FUNC(0)
INTERCEPT_DEFAULT_FUNC(1)
INTERCEPT_DEFAULT_FUNC(2)
INTERCEPT_DEFAULT_FUNC(3)
INTERCEPT_DEFAULT_FUNC(4)
INTERCEPT_DEFAULT_FUNC(5)
INTERCEPT_DEFAULT_FUNC(6)
INTERCEPT_DEFAULT_FUNC(7)
INTERCEPT_DEFAULT_FUNC(8)
INTERCEPT_DEFAULT_FUNC(9)

INTERCEPT_DEFAULT_FUNC(10)
INTERCEPT_DEFAULT_FUNC(11)
INTERCEPT_DEFAULT_FUNC(12)
INTERCEPT_DEFAULT_FUNC(13)
INTERCEPT_DEFAULT_FUNC(14)
INTERCEPT_DEFAULT_FUNC(15)
INTERCEPT_DEFAULT_FUNC(16)
INTERCEPT_DEFAULT_FUNC(17)
INTERCEPT_DEFAULT_FUNC(18)
INTERCEPT_DEFAULT_FUNC(19)

INTERCEPT_DEFAULT_FUNC(20)
INTERCEPT_DEFAULT_FUNC(21)
INTERCEPT_DEFAULT_FUNC(22)
INTERCEPT_DEFAULT_FUNC(23)
INTERCEPT_DEFAULT_FUNC(24)
INTERCEPT_DEFAULT_FUNC(25)
INTERCEPT_DEFAULT_FUNC(26)
INTERCEPT_DEFAULT_FUNC(27)
INTERCEPT_DEFAULT_FUNC(28)
INTERCEPT_DEFAULT_FUNC(29)

INTERCEPT_DEFAULT_FUNC(30)
INTERCEPT_DEFAULT_FUNC(31)
INTERCEPT_DEFAULT_FUNC(32)
INTERCEPT_DEFAULT_FUNC(33)
INTERCEPT_DEFAULT_FUNC(34)
INTERCEPT_DEFAULT_FUNC(35)
INTERCEPT_DEFAULT_FUNC(36)
INTERCEPT_DEFAULT_FUNC(37)
INTERCEPT_DEFAULT_FUNC(38)
INTERCEPT_DEFAULT_FUNC(39)

INTERCEPT_DEFAULT_FUNC(40)
INTERCEPT_DEFAULT_FUNC(41)
INTERCEPT_DEFAULT_FUNC(42)
INTERCEPT_DEFAULT_FUNC(43)
INTERCEPT_DEFAULT_FUNC(44)
INTERCEPT_DEFAULT_FUNC(45)
INTERCEPT_DEFAULT_FUNC(46)
INTERCEPT_DEFAULT_FUNC(47)
INTERCEPT_DEFAULT_FUNC(48)
INTERCEPT_DEFAULT_FUNC(49)

INTERCEPT_DEFAULT_FUNC(50)
INTERCEPT_DEFAULT_FUNC(51)
INTERCEPT_DEFAULT_FUNC(52)
INTERCEPT_DEFAULT_FUNC(53)
INTERCEPT_DEFAULT_FUNC(54)
INTERCEPT_DEFAULT_FUNC(55)
INTERCEPT_DEFAULT_FUNC(56)
INTERCEPT_DEFAULT_FUNC(57)
INTERCEPT_DEFAULT_FUNC(58)
INTERCEPT_DEFAULT_FUNC(59)

INTERCEPT_DEFAULT_FUNC(60)
INTERCEPT_DEFAULT_FUNC(61)
INTERCEPT_DEFAULT_FUNC(62)
INTERCEPT_DEFAULT_FUNC(63)
INTERCEPT_DEFAULT_FUNC(64)
INTERCEPT_DEFAULT_FUNC(65)
INTERCEPT_DEFAULT_FUNC(66)
INTERCEPT_DEFAULT_FUNC(67)
INTERCEPT_DEFAULT_FUNC(68)
INTERCEPT_DEFAULT_FUNC(69)

INTERCEPT_DEFAULT_FUNC(70)
INTERCEPT_DEFAULT_FUNC(71)
INTERCEPT_DEFAULT_FUNC(72)
INTERCEPT_DEFAULT_FUNC(73)
INTERCEPT_DEFAULT_FUNC(74)
INTERCEPT_DEFAULT_FUNC(75)
INTERCEPT_DEFAULT_FUNC(76)
INTERCEPT_DEFAULT_FUNC(77)
INTERCEPT_DEFAULT_FUNC(78)
INTERCEPT_DEFAULT_FUNC(79)

INTERCEPT_DEFAULT_FUNC(80)
INTERCEPT_DEFAULT_FUNC(81)
INTERCEPT_DEFAULT_FUNC(82)
INTERCEPT_DEFAULT_FUNC(83)
INTERCEPT_DEFAULT_FUNC(84)
INTERCEPT_DEFAULT_FUNC(85)
INTERCEPT_DEFAULT_FUNC(86)
INTERCEPT_DEFAULT_FUNC(87)
INTERCEPT_DEFAULT_FUNC(88)
INTERCEPT_DEFAULT_FUNC(89)

INTERCEPT_DEFAULT_FUNC(90)
INTERCEPT_DEFAULT_FUNC(91)
INTERCEPT_DEFAULT_FUNC(92)
INTERCEPT_DEFAULT_FUNC(93)
INTERCEPT_DEFAULT_FUNC(94)
INTERCEPT_DEFAULT_FUNC(95)
INTERCEPT_DEFAULT_FUNC(96)
INTERCEPT_DEFAULT_FUNC(97)
INTERCEPT_DEFAULT_FUNC(98)
INTERCEPT_DEFAULT_FUNC(99)

INTERCEPT_DEFAULT_FUNC(100)
INTERCEPT_DEFAULT_FUNC(101)
INTERCEPT_DEFAULT_FUNC(102)
INTERCEPT_DEFAULT_FUNC(103)
INTERCEPT_DEFAULT_FUNC(104)
INTERCEPT_DEFAULT_FUNC(105)
INTERCEPT_DEFAULT_FUNC(106)
INTERCEPT_DEFAULT_FUNC(107)
INTERCEPT_DEFAULT_FUNC(108)
INTERCEPT_DEFAULT_FUNC(109)

INTERCEPT_DEFAULT_FUNC(110)
INTERCEPT_DEFAULT_FUNC(111)
INTERCEPT_DEFAULT_FUNC(112)
INTERCEPT_DEFAULT_FUNC(113)
INTERCEPT_DEFAULT_FUNC(114)
INTERCEPT_DEFAULT_FUNC(115)
INTERCEPT_DEFAULT_FUNC(116)
INTERCEPT_DEFAULT_FUNC(117)
INTERCEPT_DEFAULT_FUNC(118)
INTERCEPT_DEFAULT_FUNC(119)

INTERCEPT_DEFAULT_FUNC(120)
INTERCEPT_DEFAULT_FUNC(121)
INTERCEPT_DEFAULT_FUNC(122)
INTERCEPT_DEFAULT_FUNC(123)
INTERCEPT_DEFAULT_FUNC(124)
INTERCEPT_DEFAULT_FUNC(125)
INTERCEPT_DEFAULT_FUNC(126)
INTERCEPT_DEFAULT_FUNC(127)
INTERCEPT_DEFAULT_FUNC(128)
INTERCEPT_DEFAULT_FUNC(129)

INTERCEPT_DEFAULT_FUNC(130)
INTERCEPT_DEFAULT_FUNC(131)
INTERCEPT_DEFAULT_FUNC(132)
INTERCEPT_DEFAULT_FUNC(133)
INTERCEPT_DEFAULT_FUNC(134)
INTERCEPT_DEFAULT_FUNC(135)
INTERCEPT_DEFAULT_FUNC(136)
INTERCEPT_DEFAULT_FUNC(137)
INTERCEPT_DEFAULT_FUNC(138)
INTERCEPT_DEFAULT_FUNC(139)

INTERCEPT_DEFAULT_FUNC(140)
INTERCEPT_DEFAULT_FUNC(141)
INTERCEPT_DEFAULT_FUNC(142)
INTERCEPT_DEFAULT_FUNC(143)
INTERCEPT_DEFAULT_FUNC(144)
INTERCEPT_DEFAULT_FUNC(145)
INTERCEPT_DEFAULT_FUNC(146)
INTERCEPT_DEFAULT_FUNC(147)
INTERCEPT_DEFAULT_FUNC(148)
INTERCEPT_DEFAULT_FUNC(149)

INTERCEPT_DEFAULT_FUNC(150)
INTERCEPT_DEFAULT_FUNC(151)
INTERCEPT_DEFAULT_FUNC(152)
INTERCEPT_DEFAULT_FUNC(153)
INTERCEPT_DEFAULT_FUNC(154)
INTERCEPT_DEFAULT_FUNC(155)
INTERCEPT_DEFAULT_FUNC(156)
INTERCEPT_DEFAULT_FUNC(157)
INTERCEPT_DEFAULT_FUNC(158)
INTERCEPT_DEFAULT_FUNC(159)

INTERCEPT_DEFAULT_FUNC(160)
INTERCEPT_DEFAULT_FUNC(161)
INTERCEPT_DEFAULT_FUNC(162)
INTERCEPT_DEFAULT_FUNC(163)
INTERCEPT_DEFAULT_FUNC(164)
INTERCEPT_DEFAULT_FUNC(165)
INTERCEPT_DEFAULT_FUNC(166)
INTERCEPT_DEFAULT_FUNC(167)
INTERCEPT_DEFAULT_FUNC(168)
INTERCEPT_DEFAULT_FUNC(169)

INTERCEPT_DEFAULT_FUNC(170)
INTERCEPT_DEFAULT_FUNC(171)
INTERCEPT_DEFAULT_FUNC(172)
INTERCEPT_DEFAULT_FUNC(173)
INTERCEPT_DEFAULT_FUNC(174)
INTERCEPT_DEFAULT_FUNC(175)
INTERCEPT_DEFAULT_FUNC(176)
INTERCEPT_DEFAULT_FUNC(177)
INTERCEPT_DEFAULT_FUNC(178)
INTERCEPT_DEFAULT_FUNC(179)

INTERCEPT_DEFAULT_FUNC(180)
INTERCEPT_DEFAULT_FUNC(181)
INTERCEPT_DEFAULT_FUNC(182)
INTERCEPT_DEFAULT_FUNC(183)
INTERCEPT_DEFAULT_FUNC(184)
INTERCEPT_DEFAULT_FUNC(185)
INTERCEPT_DEFAULT_FUNC(186)
INTERCEPT_DEFAULT_FUNC(187)
INTERCEPT_DEFAULT_FUNC(188)
INTERCEPT_DEFAULT_FUNC(189)

INTERCEPT_DEFAULT_FUNC(190)
INTERCEPT_DEFAULT_FUNC(191)
INTERCEPT_DEFAULT_FUNC(192)
INTERCEPT_DEFAULT_FUNC(193)
INTERCEPT_DEFAULT_FUNC(194)
INTERCEPT_DEFAULT_FUNC(195)
INTERCEPT_DEFAULT_FUNC(196)
INTERCEPT_DEFAULT_FUNC(197)
INTERCEPT_DEFAULT_FUNC(198)
INTERCEPT_DEFAULT_FUNC(199)

INTERCEPT_DEFAULT_FUNC(200)
INTERCEPT_DEFAULT_FUNC(201)
INTERCEPT_DEFAULT_FUNC(202)
INTERCEPT_DEFAULT_FUNC(203)
INTERCEPT_DEFAULT_FUNC(204)
INTERCEPT_DEFAULT_FUNC(205)
INTERCEPT_DEFAULT_FUNC(206)
INTERCEPT_DEFAULT_FUNC(207)
INTERCEPT_DEFAULT_FUNC(208)
INTERCEPT_DEFAULT_FUNC(209)

INTERCEPT_DEFAULT_FUNC(210)
INTERCEPT_DEFAULT_FUNC(211)
INTERCEPT_DEFAULT_FUNC(212)
INTERCEPT_DEFAULT_FUNC(213)
INTERCEPT_DEFAULT_FUNC(214)
INTERCEPT_DEFAULT_FUNC(215)
INTERCEPT_DEFAULT_FUNC(216)
INTERCEPT_DEFAULT_FUNC(217)
INTERCEPT_DEFAULT_FUNC(218)
INTERCEPT_DEFAULT_FUNC(219)

INTERCEPT_DEFAULT_FUNC(220)
INTERCEPT_DEFAULT_FUNC(221)
INTERCEPT_DEFAULT_FUNC(222)
INTERCEPT_DEFAULT_FUNC(223)
INTERCEPT_DEFAULT_FUNC(224)
INTERCEPT_DEFAULT_FUNC(225)
INTERCEPT_DEFAULT_FUNC(226)
INTERCEPT_DEFAULT_FUNC(227)
INTERCEPT_DEFAULT_FUNC(228)
INTERCEPT_DEFAULT_FUNC(229)

INTERCEPT_DEFAULT_FUNC(230)
INTERCEPT_DEFAULT_FUNC(231)
INTERCEPT_DEFAULT_FUNC(232)
INTERCEPT_DEFAULT_FUNC(233)
INTERCEPT_DEFAULT_FUNC(234)
INTERCEPT_DEFAULT_FUNC(235)
INTERCEPT_DEFAULT_FUNC(236)
INTERCEPT_DEFAULT_FUNC(237)
INTERCEPT_DEFAULT_FUNC(238)
INTERCEPT_DEFAULT_FUNC(239)

INTERCEPT_DEFAULT_FUNC(240)
INTERCEPT_DEFAULT_FUNC(241)
INTERCEPT_DEFAULT_FUNC(242)
INTERCEPT_DEFAULT_FUNC(243)
INTERCEPT_DEFAULT_FUNC(244)
INTERCEPT_DEFAULT_FUNC(245)
INTERCEPT_DEFAULT_FUNC(246)
INTERCEPT_DEFAULT_FUNC(247)
INTERCEPT_DEFAULT_FUNC(248)
INTERCEPT_DEFAULT_FUNC(249)

INTERCEPT_DEFAULT_FUNC(250)
INTERCEPT_DEFAULT_FUNC(251)
INTERCEPT_DEFAULT_FUNC(252)
INTERCEPT_DEFAULT_FUNC(253)
INTERCEPT_DEFAULT_FUNC(254)
INTERCEPT_DEFAULT_FUNC(255)
